<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<title>Bike Ledger</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#f4f4f4;padding:15px}
h2{text-align:center}
button,input{width:100%;padding:10px;margin:6px 0;font-size:16px}
button{background:#333;color:#fff;border:none;border-radius:4px}
table{width:100%;border-collapse:collapse;margin-top:15px;background:#fff}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#222;color:#fff}
.paid{color:green;font-weight:bold}
.partial{color:orange;font-weight:bold}
.due{color:red;font-weight:bold}
#msg{text-align:center;font-weight:bold;margin:10px 0}
</style>
</head>

<body>

<h2>üö¥ Bike Ledger</h2>

<button id="loginBtn">Google ‡¶¶‡¶ø‡ßü‡ßá Login</button>
<button id="logoutBtn" style="display:none">Logout</button>

<div id="app" style="display:none">

<input id="name" placeholder="‡¶Ø‡¶æ‡¶§‡ßç‡¶∞‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ">
<input id="fare" type="number" placeholder="‡¶Æ‡ßã‡¶ü ‡¶≠‡¶æ‡ßú‡¶æ">
<input id="paid" type="number" placeholder="‡¶è‡¶ñ‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ü‡¶æ‡¶ï‡¶æ">

<button onclick="saveOffline()">‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>

<p id="msg"></p>

<table>
<thead>
<tr>
<th>‡¶®‡¶æ‡¶Æ</th>
<th>‡¶∏‡¶Æ‡ßü</th>
<th>‡¶≠‡¶æ‡ßú‡¶æ</th>
<th>‡¶™‡¶æ‡¶ì‡ßü‡¶æ</th>
<th>‡¶¨‡¶æ‡¶ï‡¶ø</th>
<th>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>

</div>

<script type="module">
/* ===== Firebase CDN Imports ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import { getFirestore, addDoc, collection }
from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

/* ===== YOUR FIREBASE CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCXs85Y0GzKbQqY5V3yQY-MysMl_4ABk9U",
  authDomain: "bikeledger2k.firebaseapp.com",
  projectId: "bikeledger2k",
  storageBucket: "bikeledger2k.firebasestorage.app",
  messagingSenderId: "791926507922",
  appId: "1:791926507922:web:d6ee8ca94a505eed4d194b"
};

/* ===== Init ===== */
const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();
const provider = new GoogleAuthProvider();

/* ===== UI ===== */
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const appDiv = document.getElementById("app");
const msg = document.getElementById("msg");
const list = document.getElementById("list");

const nameEl = document.getElementById("name");
const fareEl = document.getElementById("fare");
const paidEl = document.getElementById("paid");

/* ===== Local Storage ===== */
let records = JSON.parse(localStorage.getItem("offlineData")) || [];
let currentUser = null;

/* ===== Login / Logout ===== */
loginBtn.onclick = () => signInWithPopup(auth, provider);
logoutBtn.onclick = () => signOut(auth);

/* ===== Auth State ===== */
onAuthStateChanged(auth, user=>{
  if(user){
    currentUser = user;
    loginBtn.style.display="none";
    logoutBtn.style.display="block";
    appDiv.style.display="block";
    msg.innerText = "üë§ Logged in: " + user.email;
    show();
    if(navigator.onLine) autoBackup();
  }else{
    currentUser = null;
    loginBtn.style.display="block";
    logoutBtn.style.display="none";
    appDiv.style.display="none";
  }
});

/* ===== Save Offline ===== */
window.saveOffline = function(){
  if(!currentUser) return alert("Login ‡¶ï‡¶∞‡ßÅ‡¶®");

  const name = nameEl.value;
  const fare = Number(fareEl.value);
  const paid = Number(paidEl.value);

  if(!name || !fare) return alert("‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶≠‡¶æ‡ßú‡¶æ ‡¶¶‡¶ø‡¶®");

  records.push({
    uid: currentUser.uid,
    name,
    fare,
    paid,
    due: fare - paid,
    time: new Date().toLocaleString()
  });

  localStorage.setItem("offlineData", JSON.stringify(records));
  nameEl.value=""; fareEl.value=""; paidEl.value="";
  show();
  msg.innerText = navigator.onLine ? "üåê ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶Ü‡¶õ‡ßá‡¶®" : "üì¥ ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá";
};

/* ===== Auto Backup ===== */
window.addEventListener("online", autoBackup);

async function autoBackup(){
  if(!currentUser) return;
  const myData = records.filter(r=>r.uid===currentUser.uid);
  if(myData.length===0) return;

  msg.innerText = "‚è≥ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
  for(let r of myData){
    await addDoc(collection(db,"users",currentUser.uid,"backup"), r);
  }

  records = records.filter(r=>r.uid!==currentUser.uid);
  localStorage.setItem("offlineData", JSON.stringify(records));
  show();
  msg.innerText = "‚úÖ Backup Successful";
}

/* ===== Show Table ===== */
function show(){
  list.innerHTML = records
    .filter(r=>currentUser && r.uid===currentUser.uid)
    .map(r=>{
      let status = r.due==0 ? "Paid" : (r.paid==0 ? "Due" : "Partial");
      let cls = status=="Paid"?"paid":status=="Due"?"due":"partial";
      return `
      <tr>
        <td>${r.name}</td>
        <td>${r.time}</td>
        <td>${r.fare}</td>
        <td>${r.paid}</td>
        <td>${r.due}</td>
        <td class="${cls}">${status}</td>
      </tr>`;
    }).join("");
}

show();
</script>

</body>
</html>